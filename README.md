<div align="center">

# TT-Metal · ArgMax 双 RISC-V 核心优化

<sub>Author: @haoyunkai | 浪潮科学研究院 | 2025-09</sub>
</div>

---

## 📖 背景与需求
本分支基于官方 **tt-metal v0.60.0**，聚焦于 **Reduce ArgMax** 算子的双核改造与性能优化，需求来源于 TT 官方社区：

- **GitHub Issue**：[#25552](https://github.com/tenstorrent/tt-metal/issues/25552)  
- **目标**：利用 **Wormhole / BlackHole** 每个 Tensix 核心内部的 **2 个数据移动 RISC-V 核心**，将访存密集的 ArgMax 任务并行化，实现 **单核→双核** 升级。

---

### ✅ 需求清单
| 序号 | 任务内容 | 状态 |
| ---- | -------- | ---- |
| ① | 单 Tensix 核内 **1→2** 数据移动核心改造（任务均等分割） | ✅ |
| ② | 多 Tensix 核内 **1→2** 数据移动核心改造（局部结果合并） | ✅ |
| ③ | 单元测试 vs PyTorch（误差 <1e-5） | ✅ |
| ④ | 前后性能对比（带宽/时延收益） | 🚧 进行中 |

---

### 🔍 算子简介
ArgMax 是深度学习最常用规约算子之一：**沿指定轴返回最大值下标**。

#### 1、数学定义
$$
\text{ArgMax}(X, \text{axis}) = [i_0, i_1, \dots], \quad
i_k = \mathop{\arg\max}\limits_j X[\dots, j, \dots], \; j \in [0, d_{\text{axis}})
$$
- **输出类型**：`int32` / `int64`  
- **输出形状**：去掉指定轴后的维度

#### 2、典型场景
| 任务 | 用法 |
| ---- | ---- |
| 图像分类 | `pred = tf.argmax(logits, axis=-1)` |
| 目标检测 | 选 3000 候选框中 **cls 分数最大** 的框 |
| 语义分割 | 逐像素选 **类别概率最大** 的 channel |
| 大模型推理 | 选 **词表维度最大** 的 token-id 作为下一个词 |

---

## 🧩 编译 & 运行
> 需在指定镜像环境执行

```bash
# ① 拉取分支
git clone -b feature/develop_operator http://devops.inspur.com/AIOT_FOUR/tt-metal.git

# ② 编译
./build_metal.sh

# ③ 执行单元测试
pytest tests/ttnn/unit_tests/operations/reduce/test_argmax.py -v
```

---

## 📈 Benchmark（N150 / N300）
> 以下仅为测试的几组简单数据集，详细测试数据待后续补充

### 改造前（1 RISC-V 核心）
| Shape        | Time   | Num Tensix | Num RISC-V |
|--------------|--------|------------|------------|
| [32]         | 18.50μs | 1          | 1        |
| [64]         | 24.00μs | 1          | 1        |
| [1,512]      | 21.38μs | 32         | 32       |
| [1,1024]     | 28.41μs | 56         | 56       |
| [1,65]       | 22.79μs | 5          | 5        |
| [8,10,129]   | 20.14μs | 1          | 1        |
| [1,8,160]    | 18.26μs | 10         | 10       |
| [1,256,8192] | 25.34μs | 56         | 56       |
| [32,32,32,1] | 17.99μs | 1          | 1        |

### 改造后（2 RISC-V 核心）
| Shape        | Time   | Num Tensix | Num RISC-V |
|--------------|--------|------------|------------|
| [32]         | 20.94μs | 1          | 2        |
| [64]         | 20.79μs | 1          | 2        |
| [1,512]      | 22.16μs | 32         | 64       |
| [1,1024]     | 22.87μs | 56         | 112      |
| [1,65]       | 20.96μs | 5          | 10       |
| [8,10,129]   | 23.82μs | 1          | 2        |
| [1,8,160]    | 23.85μs | 10         | 20       |
| [1,256,8192] | 29.75μs | 56         | 112      |
| [32,32,32,1] | 15.60μs | 1          | 2        |


---

## ✅ 已完成工作
1. 针对**单个 Tensix 核**，将任务均等分配在 **2 个数据移动核心**进行 ArgMax 计算。  
2. 针对**多个 Tensix 核**，将任务均等分配在**每核 2 个数据移动核心**，并完成局部结果合并。  
3. 展开相关测试，结果与 **PyTorch** 完全一致（误差 <1e-5）。

---

## 📝 后续计划
1. 补充详细的测试数据，完成**前后性能对比**，量化带宽/时延收益。  
2. 将代码**同步回 TT 官方社区**，推进 MR 合并。

---

<div align="center">

<sub>Made with  by haoyunkai | 浪潮科学研究院</sub>
</div>
```

---
